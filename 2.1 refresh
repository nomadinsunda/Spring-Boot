# ğŸ” `refresh()` ë©”ì„œë“œì˜ ì „ì²´ ë¼ì´í”„ì‚¬ì´í´ ë¶„ì„ê³¼ ApplicationContextì˜ í™•ì¥ì„±

Spring Frameworkì˜ í•µì‹¬ êµ¬ì„± ë©”ì„œë“œ ì¤‘ í•˜ë‚˜ì¸ `AbstractApplicationContext#refresh()`ëŠ” **ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì¬ì‹œì‘í•˜ëŠ” ì „ë°˜ì ì¸ ìƒëª… ì£¼ê¸° ê´€ë¦¬ ë©”ì„œë“œ**ì…ë‹ˆë‹¤. Spring Bootì˜ ìë™ êµ¬ì„±ë„ ì´ ë©”ì„œë“œ ë‚´ì—ì„œ ëª¨ë‘ ì´ë£¨ì–´ì§€ë©°, ê±°ì˜ ëª¨ë“  Spring ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì´ ê³¼ì •ì„ í†µí•´ ì„¤ì •ë©ë‹ˆë‹¤.

## âœ… 1. `refresh()` ì „ì²´ í˜¸ì¶œ íë¦„ ìˆœì„œë„

`AbstractApplicationContext#refresh()`ëŠ” ëŒ€ëµ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤:

```
refresh()
â”œâ”€â”€ prepareRefresh()
â”œâ”€â”€ obtainFreshBeanFactory()
â”œâ”€â”€ prepareBeanFactory()
â”œâ”€â”€ postProcessBeanFactory()
â”œâ”€â”€ invokeBeanFactoryPostProcessors()
â”œâ”€â”€ registerBeanPostProcessors()
â”œâ”€â”€ initMessageSource()
â”œâ”€â”€ initApplicationEventMulticaster()
â”œâ”€â”€ onRefresh()
â”œâ”€â”€ registerListeners()
â”œâ”€â”€ finishBeanFactoryInitialization()
â””â”€â”€ finishRefresh()
```

ê° ë‹¨ê³„ë¥¼ ì•„ë˜ì—ì„œ ìƒì„¸íˆ ë¶„ì„í•©ë‹ˆë‹¤.

---

## ğŸ” 2. ë‹¨ê³„ë³„ ë¶„ì„

### ğŸ§± 2.1 `prepareRefresh()`

* ì»¨í…ìŠ¤íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
* `startupDate`, `closed`, `active` í”Œë˜ê·¸ ì´ˆê¸°í™”
* `Environment`ì— ëŒ€í•œ property source ì¬ë¡œë”©
* ApplicationContext ì´ˆê¸°í™” ì‹œì‘ì„ ì„ ì–¸

### ğŸ§° 2.2 `obtainFreshBeanFactory()`

* `refreshBeanFactory()` í˜¸ì¶œ
* ê¸°ì¡´ì˜ `BeanFactory`ê°€ ìˆìœ¼ë©´ ë‹«ê³  ìƒˆë¡œ ìƒì„±
* XMLì´ë‚˜ Annotation ê¸°ë°˜ì˜ ì„¤ì • í´ë˜ìŠ¤ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ë¹ˆ ì •ì˜ ì½ìŒ

### ğŸ”§ 2.3 `prepareBeanFactory(ConfigurableListableBeanFactory)`

* ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒì„ ë“±ë¡í•¨:

  * í´ë˜ìŠ¤ ë¡œë”
  * í‘œí˜„ì‹ ì–¸ì–´ ì²˜ë¦¬ê¸° (`SpEL`)
  * í™˜ê²½ ë³€ìˆ˜
  * `ApplicationContextAware`, `ResourceLoaderAware` ë“± ê´€ë ¨ aware processor
  * ê¸°ë³¸ í›„ì²˜ë¦¬ê¸° ë“±ë¡ (e.g., `ApplicationContextAwareProcessor`)

### ğŸ›  2.4 `postProcessBeanFactory()`

* `@Configuration` í´ë˜ìŠ¤ë¥¼ í†µí•´ ì„¤ì •í•œ ì‚¬ìš©ì ì •ì˜ ì‘ì—…ì´ ì—¬ê¸°ì— ê°œì… ê°€ëŠ¥
* ë³´í†µ `AbstractApplicationContext`ë¥¼ ìƒì†í•˜ì—¬ ì˜¤ë²„ë¼ì´ë“œí•  ë•Œ ì‚¬ìš©ë¨

### ğŸ§  2.5 `invokeBeanFactoryPostProcessors()`

* **BeanFactoryPostProcessor**ì™€ **ConfigurationClassPostProcessor** í˜¸ì¶œ
* `@Configuration`, `@ComponentScan`, `@Bean`, `@Import` ë“±ì„ í•´ì„
* `BeanDefinition`ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•µì‹¬ ì§€ì 

### ğŸ”Œ 2.6 `registerBeanPostProcessors()`

* `BeanPostProcessor`ë¥¼ ë“±ë¡ (AOP, @Autowired, @Transactional ë“± ëª¨ë‘ ì´ ì‹œì ì— ì ìš©)
* ì£¼ìš” PostProcessor:

  * `AutowiredAnnotationBeanPostProcessor`
  * `CommonAnnotationBeanPostProcessor`
  * `AnnotationAwareAspectJAutoProxyCreator`

### ğŸˆ¶ 2.7 `initMessageSource()`

* ë©”ì‹œì§€ êµ­ì œí™”(i18n) ì²˜ë¦¬ë¥¼ ìœ„í•œ `MessageSource` ì„¤ì •

### ğŸ“¢ 2.8 `initApplicationEventMulticaster()`

* Application ì´ë²¤íŠ¸ ì „ë‹¬ì„ ìœ„í•œ `ApplicationEventMulticaster` ë“±ë¡

### ğŸ’¡ 2.9 `onRefresh()`

* í…œí”Œë¦¿ ë©”ì„œë“œ: í•˜ìœ„ ì»¨í…ìŠ¤íŠ¸(WebApplicationContext ë“±)ì—ì„œ ì¬ì •ì˜ ê°€ëŠ¥
* ì˜ˆ: ë‚´ì¥ í†°ìº£, ì„œë²„ ì†Œì¼“, DB ì»¤ë„¥ì…˜ í’€ ë“±ì˜ ì´ˆê¸°í™” ì§€ì 

### ğŸ“£ 2.10 `registerListeners()`

* ApplicationListenerë¥¼ ë“±ë¡
* `@EventListener`, `ApplicationListener`ê°€ ì—¬ê¸°ì— í¬í•¨ë¨

### ğŸŒ± 2.11 `finishBeanFactoryInitialization()`

* **ëª¨ë“  non-lazy singleton ë¹ˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±**
* ìˆœí™˜ ì°¸ì¡° ê°ì§€
* ì˜ì¡´ì„± ì£¼ì…, ì´ˆê¸°í™” ë©”ì„œë“œ í˜¸ì¶œ
* `@PostConstruct`, `InitializingBean` ë“± ì ìš©

### âœ… 2.12 `finishRefresh()`

* `LifecycleProcessor#onRefresh()` í˜¸ì¶œ
* ApplicationEvent: `ContextRefreshedEvent` ë°œí–‰
* JVM Hook ë˜ëŠ” SmartLifecycle Bean ì‹œì‘

---

## ğŸ§¬ 3. ApplicationContextì˜ í™•ì¥ì„±

Springì˜ ApplicationContextëŠ” ë§¤ìš° ìœ ì—°í•˜ë©° ë‹¤ìŒê³¼ ê°™ì€ í™•ì¥ ì§€ì ì„ ì œê³µí•©ë‹ˆë‹¤.

| í™•ì¥ ì§€ì                                          | ì„¤ëª…                         |
| --------------------------------------------- | -------------------------- |
| `postProcessBeanFactory()`                    | Bean ì •ì˜ ì¡°ì‘ ê°€ëŠ¥              |
| `BeanFactoryPostProcessor`                    | BeanDefinitionì„ ë™ì ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥ |
| `BeanPostProcessor`                           | Bean ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•´ ì „/í›„ ì²˜ë¦¬ ê°€ëŠ¥    |
| `ApplicationListener`                         | Spring ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°€ëŠ¥           |
| `EnvironmentAware`, `ApplicationContextAware` | ì»¨í…ìŠ¤íŠ¸ì™€ í™˜ê²½ì— ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥         |
| `SmartInitializingSingleton`                  | ëª¨ë“  Bean ì´ˆê¸°í™” ì´í›„ í›„ì²˜ë¦¬         |
| `SmartLifecycle`                              | ì»¨í…ìŠ¤íŠ¸ ì‹œì‘/ì¢…ë£Œ í›… êµ¬í˜„ ê°€ëŠ¥         |

---

## ğŸ§  ì‹¤ì „ ì˜ˆì‹œ: ì»¤ìŠ¤í…€ BeanFactoryPostProcessor

```java
@Component
public class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor {
  @Override
  public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
    BeanDefinition bd = beanFactory.getBeanDefinition("myService");
    bd.setScope(BeanDefinition.SCOPE_PROTOTYPE);
  }
}
```

â¡ `myService` ë¹ˆì„ ì‹±ê¸€í†¤ì´ ì•„ë‹Œ í”„ë¡œí† íƒ€ì…ìœ¼ë¡œ ë°”ê¿ˆ

---

## âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©     | ì„¤ëª…                                                  |
| ------ | --------------------------------------------------- |
| í•µì‹¬ ë©”ì„œë“œ | `refresh()`                                         |
| ì±…ì„     | ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”, Bean ë“±ë¡ ë° ì´ˆê¸°í™”, ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŒ…                 |
| ì¤‘ìš” ìˆœì„œ  | BeanDefinition ë“±ë¡ â†’ PostProcessor ë“±ë¡ â†’ Bean ì¸ìŠ¤í„´ìŠ¤ ìƒì„± |
| í™•ì¥ì„± ì§€ì  | PostProcessor, Listener, Lifecycle, Aware ì¸í„°í˜ì´ìŠ¤ ë“±   |

