# ğŸ§¬ BeanDefinition êµ¬ì¡° ë° `MergedBeanDefinitionPostProcessor` ì—­í•  ì™„ì „ í•´ë¶€

> â€œSpringì´ ê´€ë¦¬í•˜ëŠ” ê°ì²´ëŠ” Beanì´ ì•„ë‹ˆë¼ BeanDefinitionì´ë‹¤.
> ê·¸ ì •ì˜ê°€ ë³‘í•©ë  ë•Œ ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ê°€?â€

---

## âœ… 1. BeanDefinitionì´ë€?

Springì€ Bean ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ê¸° ì „ì— ë¨¼ì €
**â€œì´ Beanì„ ì–´ë–»ê²Œ ë§Œë“¤ ê²ƒì¸ê°€?â€** ë¼ëŠ” ì •ì˜ë¥¼ **`BeanDefinition`** í˜•íƒœë¡œ ë“±ë¡í•©ë‹ˆë‹¤.

```java
public interface BeanDefinition extends AttributeAccessor, BeanMetadataElement {
    String getBeanClassName();
    String getScope();
    boolean isLazyInit();
    boolean isPrimary();
    ConstructorArgumentValues getConstructorArgumentValues();
    MutablePropertyValues getPropertyValues();
    ...
}
```

### í•µì‹¬ ìš”ì†Œ

| ì†ì„±                   | ì„¤ëª…                              |
| -------------------- | ------------------------------- |
| beanClassName        | Beanì˜ FQCN (ë˜ëŠ” Factory ë©”ì„œë“œ ì •ë³´)  |
| scope                | singleton / prototype ë“±         |
| propertyValues       | `@Autowired`, setter ë“±ìœ¼ë¡œ ì£¼ì…ë  ê°’ë“¤ |
| constructorArguments | ìƒì„±ì ì•„ê·œë¨¼íŠ¸ ëª©ë¡                     |
| dependsOn            | ë‹¤ë¥¸ Beanê³¼ì˜ ì¢…ì†ì„± ì§€ì •                |

---

## âœ… 2. BeanDefinitionì˜ ë³‘í•©(Merge)ì´ë€?

ìŠ¤í”„ë§ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘ ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ
**ì—¬ëŸ¬ ê°œì˜ BeanDefinitionì„ ë³‘í•©**í•´ì•¼ í•©ë‹ˆë‹¤.

### ë³‘í•© ë°œìƒ ìƒí™©

| ìƒí™©                     | ì„¤ëª…                                                        |
| ---------------------- | --------------------------------------------------------- |
| Bean ìƒì†                | `<bean parent="baseBean" ... />` í˜¹ì€ `ChildBeanDefinition` |
| @Configuration + @Bean | `@Bean`ì€ ë©”ì„œë“œì´ì§€ë§Œ ë‚´ë¶€ì ìœ¼ë¡œë„ BeanDefinition                     |
| FactoryBean            | Bean ìì²´ê°€ ì•„ë‹Œ FactoryBean ì •ì˜ì™€ ì‹¤ì œ ìƒì„± Bean ê°„ ì •ë³´ ë³‘í•©            |

---

## âœ… 3. ë³‘í•©ì€ ì–¸ì œ ì¼ì–´ë‚˜ëŠ”ê°€?

ë³‘í•©ì€ **ApplicationContext.refresh()** ì¤‘ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤:

```java
DefaultListableBeanFactory.preInstantiateSingletons()
    â†’ getBean(beanName)
        â†’ getMergedLocalBeanDefinition(beanName)
```

### ğŸ“Œ í•µì‹¬ ë©”ì„œë“œ: `getMergedLocalBeanDefinition`

```java
protected RootBeanDefinition getMergedLocalBeanDefinition(String beanName) {
    BeanDefinition bd = getBeanDefinition(beanName);
    if (bd instanceof RootBeanDefinition) {
        return (RootBeanDefinition) bd;
    }
    return mergeBeanDefinition(beanName, bd);
}
```

* `GenericBeanDefinition`, `ChildBeanDefinition` â†’ `RootBeanDefinition`ìœ¼ë¡œ ë³€í™˜
* ë³‘í•©ëœ ê²°ê³¼ëŠ” ìºì‹±ë¨

---

## âœ… 4. RootBeanDefinitionì´ë€?

`RootBeanDefinition`ì€ ë³‘í•©ëœ ìµœì¢… ê²°ê³¼ë¥¼ ë‹´ëŠ” ê°ì²´ì…ë‹ˆë‹¤.
Springì€ Beanì„ ìƒì„±í•˜ê¸° ì „, ì´ í´ë˜ìŠ¤ë¥¼ í†µí•´ **ëª¨ë“  ì†ì„±ì´ ì™„ì„±ëœ BeanDefinition**ì„ í™•ë³´í•©ë‹ˆë‹¤.

```java
public class RootBeanDefinition extends AbstractBeanDefinition {
    private BeanDefinitionHolder decoratedDefinition;
    private boolean isFactoryMethodUnique;
    private BeanDefinition originatingBeanDefinition;
    ...
}
```

---

## âœ… 5. ë³‘í•© í›„ í›„ì²˜ë¦¬ê¸°: `MergedBeanDefinitionPostProcessor`

### ğŸ“Œ ê°œìš”

```java
public interface MergedBeanDefinitionPostProcessor extends BeanPostProcessor {
    void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName);
}
```

* BeanDefinitionì´ ë³‘í•©ë˜ì–´ `RootBeanDefinition`ì´ ë§Œë“¤ì–´ì§„ ì§í›„ í˜¸ì¶œë¨
* **Beanì´ ì‹¤ì œë¡œ ìƒì„±ë˜ê¸° ì „ì— ë‹¨ í•œ ë²ˆ í˜¸ì¶œë¨**

---

## âœ… 6. ì£¼ìš” í™œìš© ì˜ˆì‹œ

### ì˜ˆ: `AutowiredAnnotationBeanPostProcessor`

```java
public class AutowiredAnnotationBeanPostProcessor implements MergedBeanDefinitionPostProcessor {
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {
        // í•´ë‹¹ beanTypeì— ëŒ€í•œ @Autowired í•„ë“œ/ë©”ì„œë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ìºì‹±
    }
}
```

* Beanì´ ìƒì„±ë˜ê¸° ì „ì— `@Autowired`, `@Inject` ëŒ€ìƒ í•„ë“œë¥¼ ë©”ëª¨ë¦¬ì— ìºì‹±
* ì´í›„ `postProcessProperties()` ë‹¨ê³„ì—ì„œ ë¹ ë¥´ê²Œ ì£¼ì…í•  ìˆ˜ ìˆë„ë¡ ìµœì í™”

---

### ì˜ˆ: `CommonAnnotationBeanPostProcessor`

* `@PostConstruct`, `@PreDestroy` ëŒ€ìƒ ë©”ì„œë“œ ë¯¸ë¦¬ ì¶”ì¶œ ë° ì €ì¥

---

## âœ… 7. MergedBeanDefinitionPostProcessorì˜ ë™ì‘ ì‹œì 

### ì „ì²´ ìƒì„± íë¦„

```text
getBean(beanName)
    â†’ getMergedLocalBeanDefinition(beanName)
        â†’ ë³‘í•© ìˆ˜í–‰
        â†’ postProcessMergedBeanDefinition(...) â† ì—¬ê¸°!
    â†’ Bean ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì‘
```

> ì´ ì‹œì ì€ **ì•„ì§ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì§€ ì•Šì€ ì‹œì **ì´ë¯€ë¡œ, Bean ìì²´ì—ëŠ” ì ‘ê·¼í•˜ì§€ ì•ŠìŒ

---

## âœ… 8. ì‚¬ìš©ìê°€ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•  ìˆ˜ ìˆëŠ” ê²½ìš°

```java
@Component
public class MyMetadataScanner implements MergedBeanDefinitionPostProcessor {
    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> type, String beanName) {
        System.out.println("Scanning " + beanName + " â†’ " + type.getName());
    }

    @Override
    public Object postProcessBeforeInitialization(Object bean, String name) { return bean; }

    @Override
    public Object postProcessAfterInitialization(Object bean, String name) { return bean; }
}
```

* BeanDefinition ìˆ˜ì¤€ì—ì„œ Class ì •ë³´ë¥¼ ì–»ê³ ,
* ì»¤ìŠ¤í…€ ë©”íƒ€ë°ì´í„° í•´ì„ì´ë‚˜ ë¡œê·¸ ë“±ì„ ì ìš© ê°€ëŠ¥

---

## âœ… 9. ì •ë¦¬ ë‹¤ì´ì–´ê·¸ë¨

```text
BeanDefinition ë“±ë¡
    â†“
GenericBeanDefinition or ChildBeanDefinition
    â†“ (getBean)
RootBeanDefinition â† ë³‘í•© ìˆ˜í–‰
    â†“
postProcessMergedBeanDefinition() í˜¸ì¶œ
    â†“
Bean ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì‘
```

---

## âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©             | ì„¤ëª…                                                                            |
| -------------- | ----------------------------------------------------------------------------- |
| BeanDefinition | Beanì„ ì–´ë–»ê²Œ ë§Œë“¤ì§€ ì •ì˜í•˜ëŠ” ê°ì²´                                                         |
| ë³‘í•©ì´ í•„ìš”í•œ ì´ìœ      | ìƒì†, íŒ©í† ë¦¬, `@Configuration` ë³µí•© êµ¬ì¡° ì²˜ë¦¬                                            |
| ë³‘í•©ëœ ê²°ê³¼         | `RootBeanDefinition`                                                          |
| ë³‘í•© í›„ í›„ì²˜ë¦¬       | `MergedBeanDefinitionPostProcessor`ì—ì„œ ìˆ˜í–‰                                      |
| ì£¼ìš” êµ¬í˜„ì²´         | `AutowiredAnnotationBeanPostProcessor`, `CommonAnnotationBeanPostProcessor` ë“± |
| í™œìš© ëª©ì           | ì£¼ì… ëŒ€ìƒ í•„ë“œ/ë©”ì„œë“œ ë¯¸ë¦¬ ìºì‹±í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ                                                    |

