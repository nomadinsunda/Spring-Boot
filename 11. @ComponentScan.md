# ğŸ§  @ComponentScan ì™„ì „ í•´ë¶€ â€” `ClassPathBeanDefinitionScanner`ì˜ ë™ì‘ ì›ë¦¬

> "Springì€ ì–´ë–»ê²Œ í´ë˜ìŠ¤íŒ¨ìŠ¤ì—ì„œ ì»´í¬ë„ŒíŠ¸ë¥¼ ìŠ¤ìŠ¤ë¡œ ì°¾ì•„ Beanìœ¼ë¡œ ë“±ë¡í• ê¹Œ?"

---

## âœ… ê°œìš”: ì™œ `@ComponentScan`ì´ ì¤‘ìš”í•œê°€?

Springì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œìê°€ ì§ì ‘ ë¹ˆì„ ë“±ë¡í•˜ì§€ ì•Šì•„ë„,
**í´ë˜ìŠ¤ ê²½ë¡œ(Classpath)ì—ì„œ íŠ¹ì • ì• ë…¸í…Œì´ì…˜(@Component, @Service ë“±)ì„ ì°¾ê³ **,
ìë™ìœ¼ë¡œ ì»¨í…Œì´ë„ˆì— ë“±ë¡í•´ì¤ë‹ˆë‹¤.
ì´ê²ƒì´ ë°”ë¡œ `@ComponentScan`ì˜ ì—­í• ì´ë©°, ê·¸ ë‚´ë¶€ì—ì„œ ì‹¤ì œ ìŠ¤ìº”ì„ ìˆ˜í–‰í•˜ëŠ” ì£¼ì²´ê°€
\*\*`ClassPathBeanDefinitionScanner`\*\*ì…ë‹ˆë‹¤.

---

## âœ… 1. `@ComponentScan` ë‚´ë¶€ ì²˜ë¦¬ íë¦„

```java
@Configuration
@ComponentScan(basePackages = "com.example")
public class AppConfig {}
```

### ë™ì‘ íë¦„ ìš”ì•½:

```
1. @ComponentScan ê°ì§€
2. ConfigurationClassParser ë¶„ì„
3. ComponentScanAnnotationParser ì‹¤í–‰
4. ClassPathBeanDefinitionScanner ìƒì„± ë° ì‹¤í–‰
5. í›„ë³´ í´ë˜ìŠ¤ â†’ BeanDefinition ìƒì„±
6. BeanDefinitionRegistryì— ë“±ë¡
```

---

## âœ… 2. í•µì‹¬ í´ë˜ìŠ¤ ê´€ê³„ êµ¬ì¡°

| í´ë˜ìŠ¤                              | ì—­í•                                                  |
| -------------------------------- | -------------------------------------------------- |
| `ConfigurationClassParser`       | `@ComponentScan` í¬í•¨ëœ ì„¤ì • í´ë˜ìŠ¤ ë¶„ì„                     |
| `ComponentScanAnnotationParser`  | `@ComponentScan` ì• ë„ˆí…Œì´ì…˜ì˜ ì†ì„± í•´ì„                      |
| `ClassPathBeanDefinitionScanner` | ì‹¤ì œ ìŠ¤ìº” ë° BeanDefinition ìƒì„± ë‹´ë‹¹                       |
| `BeanDefinitionRegistry`         | ìŠ¤ìº”ëœ ê²°ê³¼ë¥¼ ë“±ë¡í•˜ëŠ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ (ë³´í†µ DefaultListableBeanFactory) |

---

## âœ… 3. ComponentScanAnnotationParser ë¶„ì„

Springì€ `@ComponentScan`ì´ ë¶™ì€ í´ë˜ìŠ¤ì—ì„œ ë‹¤ìŒì„ í•´ì„í•©ë‹ˆë‹¤:

```java
ComponentScanAnnotationParser parser = new ComponentScanAnnotationParser(...);
Set<BeanDefinitionHolder> scannedBeans = parser.parse(componentScanAnnotation, declaringClass);
```

### ì£¼ìš” ì†ì„± í•´ì„:

| ì†ì„±                  | ì„¤ëª…                                |
| ------------------- | --------------------------------- |
| `basePackages`      | ìŠ¤ìº”í•  íŒ¨í‚¤ì§€ ëª©ë¡                        |
| `includeFilters`    | ìŠ¤ìº” í¬í•¨ ì¡°ê±´                          |
| `excludeFilters`    | ìŠ¤ìº” ì œì™¸ ì¡°ê±´                          |
| `useDefaultFilters` | ê¸°ë³¸ í•„í„°(`@Component`) í¬í•¨ ì—¬ë¶€         |
| `resourcePattern`   | class íŒŒì¼ íƒìƒ‰ íŒ¨í„´ (ê¸°ë³¸: `**/*.class`) |

---

## âœ… 4. ClassPathBeanDefinitionScanner ì‘ë™ ë°©ì‹

ì´ í´ë˜ìŠ¤ê°€ ì‹¤ì œë¡œ ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ê³ , BeanDefinitionì„ ìƒì„±í•©ë‹ˆë‹¤.

### í•µì‹¬ ë©”ì„œë“œ: `doScan(...)`

```java
protected Set<BeanDefinitionHolder> doScan(String... basePackages) {
    for (String basePackage : basePackages) {
        Set<BeanDefinition> candidates = findCandidateComponents(basePackage);
        for (BeanDefinition candidate : candidates) {
            // Bean ì´ë¦„ ê²°ì •, ìŠ¤ì½”í”„ ì„¤ì •, ì¡°ê±´ ê²€ì‚¬ ë“±
            registry.registerBeanDefinition(beanName, candidate);
        }
    }
}
```

---

### ë‚´ë¶€ íë¦„: `findCandidateComponents(String basePackage)`

```java
public Set<BeanDefinition> findCandidateComponents(String basePackage) {
    Set<BeanDefinition> candidates = new LinkedHashSet<>();
    String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +
        resolveBasePackage(basePackage) + "/" + this.resourcePattern;

    Resource[] resources = this.resourcePatternResolver.getResources(packageSearchPath);

    for (Resource resource : resources) {
        MetadataReader metadataReader = this.metadataReaderFactory.getMetadataReader(resource);

        if (isCandidateComponent(metadataReader)) {
            ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);
            sbd.setResource(resource);
            sbd.setSource(resource);
            candidates.add(sbd);
        }
    }

    return candidates;
}
```

---

## âœ… 5. í›„ë³´ í´ë˜ìŠ¤ íŒë‹¨ ê¸°ì¤€

### `isCandidateComponent(metadataReader)`

```java
return metadataReader.getAnnotationMetadata().isIndependent() &&
       metadataReader.getAnnotationMetadata().isAnnotated("org.springframework.stereotype.Component");
```

### ì¦‰, ë‹¤ìŒì„ ëª¨ë‘ ë§Œì¡±í•´ì•¼ ì»´í¬ë„ŒíŠ¸ í›„ë³´ë¡œ ì¸ì •ë©ë‹ˆë‹¤:

1. **ë…ë¦½ í´ë˜ìŠ¤**ì—¬ì•¼ í•¨ (static, non-inner)
2. `@Component` ë˜ëŠ” íŒŒìƒ ì• ë„ˆí…Œì´ì…˜ì´ ì¡´ì¬í•´ì•¼ í•¨

---

## âœ… 6. BeanDefinition ìƒì„±

í›„ë³´ í´ë˜ìŠ¤ê°€ ê°ì§€ë˜ë©´ `ScannedGenericBeanDefinition` ê°ì²´ë¡œ ê°ìŒ‰ë‹ˆë‹¤.

```java
ScannedGenericBeanDefinition beanDef = new ScannedGenericBeanDefinition(metadataReader);
```

ì—¬ê¸°ì—ëŠ” ë‹¤ìŒ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤:

| í•­ëª©            | ì˜ˆì‹œ                              |
| ------------- | ------------------------------- |
| beanClassName | `com.example.MyService`         |
| scope         | `singleton` (ê¸°ë³¸ê°’)               |
| metadata      | `AnnotationMetadata` (ì• ë„ˆí…Œì´ì…˜ ì •ë³´) |

---

## âœ… 7. BeanDefinitionRegistryì— ë“±ë¡

```java
registry.registerBeanDefinition(beanName, beanDefinition);
```

ì´í›„ `ApplicationContext.refresh()` ì¤‘
`DefaultListableBeanFactory.getBean()` í˜¸ì¶œ ì‹œ
ì‹¤ì œ Bean ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤.

---

## âœ… 8. ì»¤ìŠ¤í…€ í•„í„°ì™€ í™•ì¥ ê¸°ëŠ¥

### include/exclude í•„í„° ì˜ˆì‹œ

```java
@ComponentScan(
  basePackages = "com.example",
  includeFilters = @Filter(type = FilterType.REGEX, pattern = ".*Service"),
  excludeFilters = @Filter(type = FilterType.ANNOTATION, classes = Controller.class)
)
```

### ì§€ì›ë˜ëŠ” FilterType

| íƒ€ì…               | ì„¤ëª…                            |
| ---------------- | ----------------------------- |
| ANNOTATION       | `@Component`, `@Repository` ë“± |
| ASSIGNABLE\_TYPE | íŠ¹ì • íƒ€ì…ì˜ ì„œë¸Œíƒ€ì…                   |
| CUSTOM           | `TypeFilter` ì§ì ‘ êµ¬í˜„            |
| REGEX            | í´ë˜ìŠ¤ ì´ë¦„ ì •ê·œí‘œí˜„ì‹                  |
| ASPECTJ          | AspectJ í‘œí˜„ì‹                   |

---

## âœ… ì „ì²´ ë™ì‘ ìš”ì•½ íë¦„ë„

```text
@Configuration
@ComponentScan("com.app")

â†’ ConfigurationClassParser
   â†’ ComponentScanAnnotationParser
     â†’ ClassPathBeanDefinitionScanner
       â†’ findCandidateComponents()
         â†’ isCandidateComponent()
         â†’ ScannedGenericBeanDefinition ìƒì„±
         â†’ BeanDefinitionRegistry ì— ë“±ë¡
```

---

## âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©       | ì„¤ëª…                                                       |
| -------- | -------------------------------------------------------- |
| ì£¼ìš” ê¸°ëŠ¥    | í´ë˜ìŠ¤íŒ¨ìŠ¤ì—ì„œ ì»´í¬ë„ŒíŠ¸ í›„ë³´ë¥¼ ìë™ íƒìƒ‰                                   |
| í•µì‹¬ í´ë˜ìŠ¤   | `ClassPathBeanDefinitionScanner`                         |
| ìŠ¤ìº” ëŒ€ìƒ ê¸°ì¤€ | `@Component` ê³„ì—´ + ë…ë¦½ í´ë˜ìŠ¤ ì—¬ë¶€                              |
| ê²°ê³¼ë¬¼      | `ScannedGenericBeanDefinition`                           |
| ìµœì¢… ë“±ë¡ ëŒ€ìƒ | `BeanDefinitionRegistry` (ë³´í†µ DefaultListableBeanFactory) |
