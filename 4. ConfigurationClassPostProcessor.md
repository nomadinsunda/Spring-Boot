# ğŸ§  `ConfigurationClassPostProcessor` ì™„ì „ ì •ë³µ â€” `@Configuration` í´ë˜ìŠ¤ ì²˜ë¦¬ì˜ ë¹„ë°€

> "Springì˜ ëª¨ë“  Bean ì„¤ì •ì´ ë™ì‘í•˜ëŠ” ì§„ì§œ ë¹„ë°€ì€ ì—¬ê¸° ìˆë‹¤."

---

## ğŸ”° ë“¤ì–´ê°€ë©°

Springì—ì„œ `@Configuration` í´ë˜ìŠ¤ëŠ” ë‹¨ìˆœí•œ ìë°” í´ë˜ìŠ¤ê°€ ì•„ë‹™ë‹ˆë‹¤.
ì´ëŠ” Spring Containerê°€ ì´í•´í•˜ê³ , ë¶„ì„í•˜ê³ , íŠ¹ë³„í•˜ê²Œ ë‹¤ë£¨ëŠ” **êµ¬ì„± ë©”íƒ€ë°ì´í„° í´ë˜ìŠ¤**ì…ë‹ˆë‹¤.

ê·¸ ì¤‘ì‹¬ì—ì„œ ì‘ë™í•˜ëŠ” ê²ƒì´ ë°”ë¡œ \*\*`ConfigurationClassPostProcessor`\*\*ì…ë‹ˆë‹¤.

---

## 1ï¸âƒ£ ConfigurationClassPostProcessorë€?

### ğŸ“Œ ì •ì˜

```java
public class ConfigurationClassPostProcessor implements BeanDefinitionRegistryPostProcessor, PriorityOrdered {
    ...
}
```

* `BeanDefinitionRegistryPostProcessor`ë¥¼ êµ¬í˜„ â†’ BeanFactory ì´ˆê¸°í™” ì „ BeanDefinitionì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŒ
* `@Configuration`, `@Component`, `@Import`, `@ImportResource`, `@ComponentScan` ë“± **ëª¨ë“  êµ¬ì„± ë©”íƒ€ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•µì‹¬ í´ë˜ìŠ¤**

---

## 2ï¸âƒ£ ë™ì‘ ì‹œì ê³¼ ëª©ì 

### ğŸ”§ BeanFactory ì´ˆê¸°í™” ì „ ë™ì‘

Spring ë¶€íŠ¸ìŠ¤íŠ¸ë© ê³¼ì •ì—ì„œ `ApplicationContext.refresh()` â†’ `invokeBeanFactoryPostProcessors()` í˜¸ì¶œ ì‹œ ë“±ë¡ë©ë‹ˆë‹¤.

```java
ConfigurationClassPostProcessor
    â””â”€â”€ postProcessBeanDefinitionRegistry()
        â””â”€â”€ processConfigBeanDefinitions()
            â””â”€â”€ parse() â†’ validate() â†’ loadBeanDefinitions()
```

> ì¦‰, `@Configuration`ì„ ë¶„ì„í•˜ê³  ê·¸ ë‚´ë¶€ì˜ `@Bean` ë“±ì„ **BeanDefinitionìœ¼ë¡œ ë“±ë¡**í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

---

## 3ï¸âƒ£ ì „ì²´ ë™ì‘ íë¦„ ìš”ì•½

```
ApplicationContext.refresh()
    â””â”€â”€ invokeBeanFactoryPostProcessors()
        â””â”€â”€ ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry()
            â”œâ”€â”€ @Configuration í´ë˜ìŠ¤ íƒìƒ‰
            â”œâ”€â”€ êµ¬ì„± ì •ë³´ íŒŒì‹± (ConfigurationClassParser)
            â”œâ”€â”€ @Import ì²˜ë¦¬
            â”œâ”€â”€ @ComponentScan ì²˜ë¦¬
            â”œâ”€â”€ @Bean ë©”ì„œë“œ ë“±ë¡
            â””â”€â”€ ImportBeanDefinitionRegistrar / ImportSelector ë“± í˜¸ì¶œ
```

---

## 4ï¸âƒ£ ì£¼ìš” ë©”ì„œë“œ ìƒì„¸ ë¶„ì„

---

### ğŸ” 1. `postProcessBeanDefinitionRegistry()`

```java
@Override
public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {
    processConfigBeanDefinitions(registry);
}
```

> â†’ í•µì‹¬ ë¡œì§ì„ `processConfigBeanDefinitions()`ì— ìœ„ì„í•©ë‹ˆë‹¤.

---

### ğŸ” 2. `processConfigBeanDefinitions()`

```java
public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {
    List<BeanDefinitionHolder> configCandidates = findCandidates(registry);

    // íŒŒì„œ ì¤€ë¹„
    ConfigurationClassParser parser = new ConfigurationClassParser(...);

    // 1ì°¨ íŒŒì‹± ì‹œì‘
    parser.parse(configCandidates);
    parser.validate();

    // íŒŒì‹± ê²°ê³¼ë¡œë¶€í„° BeanDefinition ìƒì„±
    this.reader.loadBeanDefinitions(configurationClasses);
}
```

---

### ğŸ” 3. ConfigurationClassParserì˜ ì—­í• 

```java
public void parse(Set<BeanDefinitionHolder> configCandidates) {
    for (BeanDefinitionHolder holder : configCandidates) {
        ConfigurationClass configClass = new ConfigurationClass(...);
        this.sourceClass = asSourceClass(configClass);
        processConfigurationClass(configClass);
    }
}
```

#### ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒì„ íŒŒì‹±:

| ì• ë„ˆí…Œì´ì…˜             | íŒŒì‹± ê²°ê³¼                                              |
| ----------------- | -------------------------------------------------- |
| `@ComponentScan`  | â†’ ìŠ¤ìº”ëœ í´ë˜ìŠ¤ë“¤ì„ ë‹¤ì‹œ ì¬ê·€ì ìœ¼ë¡œ íŒŒì‹±                            |
| `@Import`         | â†’ ImportSelector, ImportBeanDefinitionRegistrar ì²˜ë¦¬ |
| `@PropertySource` | â†’ Environmentì— í”„ë¡œí¼í‹° ì¶”ê°€                             |
| `@Bean` ë©”ì„œë“œ       | â†’ MethodMetadataë¡œ ìº¡ìŠí™” í›„ ì¶”í›„ BeanDefinitionìœ¼ë¡œ ë³€í™˜     |

---

### ğŸ” 4. loadBeanDefinitions()

```java
public void loadBeanDefinitions(Set<ConfigurationClass> configurationModel) {
    for (ConfigurationClass configClass : configurationModel) {
        // 1. @Bean ë©”ì„œë“œ â†’ BeanDefinition ë“±ë¡
        loadBeanDefinitionsForConfigurationClass(configClass);
    }
}
```

#### ì˜ˆ: @Bean ë©”ì„œë“œ â†’ ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡

```java
@Bean
public UserService userService() {
    return new UserServiceImpl();
}
```

ìœ„ ë©”ì„œë“œëŠ” ë‹¤ìŒê³¼ ê°™ì€ BeanDefinitionìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤:

```text
BeanDefinition:
    beanClass: ConfigurationClass$$EnhancerByCGLIB
    factoryMethodName: userService
    factoryBeanName: myConfigClass
```

---

## 5ï¸âƒ£ ImportSelectorì™€ ImportBeanDefinitionRegistrar

### âœ… ImportSelector

```java
public interface ImportSelector {
    String[] selectImports(AnnotationMetadata importingClassMetadata);
}
```

* êµ¬ì„± í´ë˜ìŠ¤ë¥¼ **ì§ì ‘ ë™ì ìœ¼ë¡œ ë¦¬í„´**
* ì˜ˆ: `@EnableAsync` â†’ `AsyncConfigurationSelector`

### âœ… DeferredImportSelector

* `@Configuration` ë¶„ì„ì´ ëë‚œ í›„ ì§€ì—° ì²˜ë¦¬ìš© Selectors

---

### âœ… ImportBeanDefinitionRegistrar

```java
public interface ImportBeanDefinitionRegistrar {
    void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry);
}
```

* BeanDefinitionì„ **ì§ì ‘ ë“±ë¡**
* ì˜ˆ: `MapperScan`, `EnableJpaRepositories`

---

## 6ï¸âƒ£ CGLIB í”„ë¡ì‹œ ì²˜ë¦¬

```java
@Configuration(proxyBeanMethods = true)
public class AppConfig { ... }
```

Springì€ `@Configuration` í´ë˜ìŠ¤ì— ëŒ€í•´ **CGLIB ì„œë¸Œí´ë˜ì‹±**ì„ ì‚¬ìš©í•˜ì—¬ `@Bean` ë©”ì„œë“œë¥¼ í”„ë¡ì‹œí•©ë‹ˆë‹¤.

### ëª©ì 

* `@Bean` ë©”ì„œë“œ ê°„ í˜¸ì¶œ ì‹œì—ë„ **ì‹±ê¸€í†¤ ìœ ì§€**

### ì˜ˆì‹œ

```java
@Bean
public A a() { return new A(); }

@Bean
public B b() { return new B(a()); } // ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ê°€ ë°˜í™˜ë¨
```

---

## âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| ë‹¨ê³„                                    | ì„¤ëª…                                                         |
| ------------------------------------- | ---------------------------------------------------------- |
| `postProcessBeanDefinitionRegistry()` | ApplicationContext ë¦¬í”„ë ˆì‹œ ì¤‘ ì´ˆê¸° ì‹¤í–‰ë¨                           |
| `ConfigurationClassParser`            | `@Configuration` ê´€ë ¨ ëª¨ë“  ë©”íƒ€ë°ì´í„° íŒŒì‹± ì²˜ë¦¬                         |
| `loadBeanDefinitions()`               | `@Bean` ë©”ì„œë“œ â†’ BeanDefinitionìœ¼ë¡œ ë“±ë¡                          |
| `@Import` ê´€ë ¨                          | `ImportSelector`, `ImportBeanDefinitionRegistrar` ë™ì  ë“±ë¡ ìˆ˜í–‰ |
| CGLIB í”„ë¡ì‹œ                             | Bean ê°„ ë©”ì„œë“œ í˜¸ì¶œ ì‹œ ì‹±ê¸€í†¤ ìœ ì§€ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë¨                            |


