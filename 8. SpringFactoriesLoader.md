# ğŸ” SpringFactoriesLoader ì™„ì „ í•´ë¶€ â€” Spring í™•ì¥ ë©”íƒ€ë°ì´í„° ë¡œë”©ì˜ ì—”ì§„

> â€œìë™ ì„¤ì •, ë¦¬ìŠ¤ë„ˆ, í›„ì²˜ë¦¬ê¸°â€¦ ê·¸ ëª¨ë“  ê²ƒì€ ê²°êµ­ ì´ í´ë˜ìŠ¤ì—ì„œ ì‹œì‘ëœë‹¤.â€

---

## âœ… 1. ê°œìš” â€” ë¬´ì—‡ì„ í•˜ëŠ” í´ë˜ìŠ¤ì¸ê°€?

`SpringFactoriesLoader`ëŠ” Spring Framework (spring-core ëª¨ë“ˆ)ì— í¬í•¨ëœ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

### ğŸ“Œ ëª©ì 

* `META-INF/spring.factories` íŒŒì¼ì„ ì½ì–´ì„œ,
* íŠ¹ì • ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ **í´ë˜ìŠ¤íŒ¨ìŠ¤ ìƒ ëª¨ë“  JAR**ì—ì„œ ë³‘í•©í•˜ì—¬ ìˆ˜ì§‘

### ğŸ“¦ ìœ„ì¹˜

```java
package org.springframework.core.io.support;
```

---

## âœ… 2. ì£¼ìš” ê¸°ëŠ¥ ìš”ì•½

| ë©”ì„œë“œ                                              | ì„¤ëª…                            |
| ------------------------------------------------ | ----------------------------- |
| `loadFactoryNames(Class, ClassLoader)`           | ì£¼ì–´ì§„ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ ì´ë¦„ ëª©ë¡ ë°˜í™˜   |
| `loadFactories(Class, ClassLoader)`              | êµ¬í˜„ì²´ í´ë˜ìŠ¤ë“¤ì„ ì‹¤ì œë¡œ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜ |
| `instantiateFactory(String, Class, ClassLoader)` | í´ë˜ìŠ¤ ì´ë¦„ì„ ì¸ìŠ¤í„´ìŠ¤í™”                 |

---

## âœ… 3. ì „ì²´ êµ¬ì¡° ì‚´í´ë³´ê¸°

### ğŸ”§ ì •ì  ìƒìˆ˜ ì •ì˜

```java
public final class SpringFactoriesLoader {

    public static final String FACTORIES_RESOURCE_LOCATION = "META-INF/spring.factories";

    private static final Map<ClassLoader, MultiValueMap<String, String>> cache = new ConcurrentReferenceHashMap<>();
}
```

* `FACTORIES_RESOURCE_LOCATION`: `META-INF/spring.factories` ê²½ë¡œ ìƒìˆ˜
* `cache`: ë¡œë”©í•œ ë‚´ìš©ì„ ë©”ëª¨ë¦¬ì— ìºì‹± (í´ë˜ìŠ¤ë¡œë” ë³„ë¡œ)

---

### ğŸ“˜ í•µì‹¬ ë©”ì„œë“œ 1: `loadFactoryNames`

```java
public static List<String> loadFactoryNames(Class<?> factoryType, @Nullable ClassLoader classLoader) {
    Assert.notNull(factoryType, "'factoryType' must not be null");
    ClassLoader classLoaderToUse = classLoader != null ? classLoader : SpringFactoriesLoader.class.getClassLoader();
    MultiValueMap<String, String> result = loadSpringFactories(classLoaderToUse);
    List<String> factoryClassNames = result.get(factoryType.getName());
    return factoryClassNames != null ? factoryClassNames : Collections.emptyList();
}
```

### âœ… ì£¼ìš” í¬ì¸íŠ¸

* `factoryType.getName()` = `"org.springframework.boot.autoconfigure.EnableAutoConfiguration"` ì™€ ê°™ì€ FQCN
* `loadSpringFactories()` í˜¸ì¶œë¡œ ì‹¤ì œ ë©”íƒ€ì •ë³´ ë¡œë”©
* ë°˜í™˜ ê°’ì€ **í´ë˜ìŠ¤ ì´ë¦„ ë¬¸ìì—´ ëª©ë¡**

---

### ğŸ“˜ í•µì‹¬ ë©”ì„œë“œ 2: `loadSpringFactories`

```java
private static MultiValueMap<String, String> loadSpringFactories(ClassLoader classLoader) {
    MultiValueMap<String, String> result = cache.get(classLoader);
    if (result != null) return result;

    try {
        Enumeration<URL> urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION);
        result = new LinkedMultiValueMap<>();

        while (urls.hasMoreElements()) {
            URL url = urls.nextElement();
            Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url));

            for (Map.Entry<?, ?> entry : properties.entrySet()) {
                String key = ((String) entry.getKey()).trim();
                for (String value : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) {
                    result.add(key, value.trim());
                }
            }
        }

        cache.put(classLoader, result);
        return result;

    } catch (IOException ex) {
        throw new IllegalArgumentException("Unable to load factories from location [" + FACTORIES_RESOURCE_LOCATION + "]", ex);
    }
}
```

### âœ… ì£¼ìš” í¬ì¸íŠ¸

* `classLoader.getResources(...)`: í´ë˜ìŠ¤íŒ¨ìŠ¤ ìƒ ëª¨ë“  JARì—ì„œ `META-INF/spring.factories` íŒŒì¼ íƒìƒ‰
* `PropertiesLoaderUtils.loadProperties(...)`: `.properties` íŒŒì¼ì„ ìë°”ì˜ `Properties`ë¡œ ë³€í™˜
* ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„ëœ í´ë˜ìŠ¤ ì´ë¦„ë“¤ì„ `List<String>`ìœ¼ë¡œ ë‚˜ëˆ ì„œ `MultiValueMap<String, String>`ì— ì €ì¥

---

### ğŸ“˜ í•µì‹¬ ë©”ì„œë“œ 3: `loadFactories`

```java
public static <T> List<T> loadFactories(Class<T> factoryType, @Nullable ClassLoader classLoader) {
    Assert.notNull(factoryType, "'factoryType' must not be null");

    ClassLoader classLoaderToUse = classLoader != null ? classLoader : SpringFactoriesLoader.class.getClassLoader();
    List<String> factoryNames = loadFactoryNames(factoryType, classLoaderToUse);
    List<T> result = new ArrayList<>(factoryNames.size());

    for (String factoryName : factoryNames) {
        T instance = instantiateFactory(factoryName, factoryType, classLoaderToUse);
        result.add(instance);
    }

    AnnotationAwareOrderComparator.sort(result);
    return result;
}
```

* `loadFactoryNames()` í˜¸ì¶œë¡œ í´ë˜ìŠ¤ ì´ë¦„ ëª©ë¡ í™•ë³´
* `instantiateFactory()`ë¡œ ì¸ìŠ¤í„´ìŠ¤í™”
* `@Order` ë˜ëŠ” `Ordered` ì¸í„°í˜ì´ìŠ¤ì— ë”°ë¼ ì •ë ¬ê¹Œì§€ ìˆ˜í–‰

---

### ğŸ“˜ ì„œë¸Œ ë©”ì„œë“œ: `instantiateFactory`

```java
private static <T> T instantiateFactory(String factoryImplementationName, Class<T> factoryType, ClassLoader classLoader) {
    Class<?> factoryImplementationClass = ClassUtils.forName(factoryImplementationName, classLoader);
    if (!factoryType.isAssignableFrom(factoryImplementationClass)) {
        throw new IllegalArgumentException(...);
    }
    return (T) BeanUtils.instantiateClass(factoryImplementationClass);
}
```

* `ClassUtils.forName`: ë¬¸ìì—´ë¡œ í´ë˜ìŠ¤ ë¡œë”©
* `BeanUtils.instantiateClass`: ê¸°ë³¸ ìƒì„±ìë¥¼ í†µí•´ ì¸ìŠ¤í„´ìŠ¤í™”

---

## âœ… ë™ì‘ ìš”ì•½ íë¦„ë„

```
Spring Boot ê¸°ë™ ì‹œ
 â†“
@EnableAutoConfiguration
 â†“
AutoConfigurationImportSelector
 â†“
SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class, ...)
 â†“
â†’ classpathì˜ ëª¨ë“  META-INF/spring.factories íƒìƒ‰
â†’ key = EnableAutoConfiguration, value = êµ¬ì„± í´ë˜ìŠ¤ ëª©ë¡
â†’ êµ¬ì„± í´ë˜ìŠ¤ë“¤ ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡
```

---

## ğŸ“¦ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê³³

| ì‚¬ìš© ìœ„ì¹˜ í´ë˜ìŠ¤                            | ì—­í•  ìš”ì•½                                    |
| ------------------------------------ | ---------------------------------------- |
| `AutoConfigurationImportSelector`    | ìë™ ì„¤ì • í´ë˜ìŠ¤ ë¡œë”© (`EnableAutoConfiguration`) |
| `SpringApplication`                  | `ApplicationListener`, `RunListener` ë¡œë”©  |
| `ConfigDataEnvironmentPostProcessor` | `EnvironmentPostProcessor` ë¡œë”©            |
| `FailureAnalyzers`                   | ì˜ˆì™¸ ë¶„ì„ê¸° ë¡œë”©                                |

---

## âœ… ë§ˆë¬´ë¦¬ ìš”ì•½

| í•­ëª©                     | ë‚´ìš©                                   |
| ---------------------- | ------------------------------------ |
| ì—­í•                      | í´ë˜ìŠ¤íŒ¨ìŠ¤ ìƒì˜ ëª¨ë“  `spring.factories` ë³‘í•© ë¡œë”© |
| ë°˜í™˜ íƒ€ì…                  | Key: ì¸í„°í˜ì´ìŠ¤ ì´ë¦„, Value: í´ë˜ìŠ¤ ì´ë¦„ ë¦¬ìŠ¤íŠ¸     |
| í™œìš© ì˜ˆì‹œ                  | ìë™ ì„¤ì •, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ, í™˜ê²½ í›„ì²˜ë¦¬ ë“± í™•ì¥ì          |
| ìºì‹œ ê¸°ëŠ¥                  | ClassLoader ê¸°ì¤€ìœ¼ë¡œ ë©”ëª¨ë¦¬ ìºì‹± ìˆ˜í–‰           |
| ì •ë ¬ ê¸°ëŠ¥ (`@Order`) ì§€ì› ì—¬ë¶€ | O (AnnotationAwareOrderComparator)   |
